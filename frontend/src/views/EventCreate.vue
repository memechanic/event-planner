<template>
  <div class="max-w-2xl mx-auto px-4 py-8">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="mb-8">
      <router-link 
        to="/" 
        class="inline-flex items-center text-gray-600 hover:text-blue-600 mb-4 group transition-colors"
      >
        <svg 
          class="w-5 h-5 mr-2 transform group-hover:-translate-x-0.5 transition-transform" 
          fill="none" 
          stroke="currentColor" 
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        –ù–∞ –≥–ª–∞–≤–Ω—É—é
      </router-link>
      
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-sm">
          <span class="text-white text-lg">üìÖ</span>
        </div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">
          –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
        </h1>
      </div>
      <p class="text-gray-600 mt-2 max-w-3xl">
        –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –¥—Ä—É–∑—å—è–º–∏ –∏–ª–∏ –∫–æ–ª–ª–µ–≥–∞–º–∏
      </p>
    </div>
    
    <!-- –§–æ—Ä–º–∞ -->
    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-gray-100">
      <form @submit.prevent="handleSubmit" class="space-y-8">
        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
        <div>
          <label for="title" class="block text-sm font-semibold text-gray-800 mb-2">
            –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è <span class="text-red-500">*</span>
          </label>
          <input
            id="title"
            v-model="title"
            type="text"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í—Å—Ç—Ä–µ—á–∞ –∫–æ–º–∞–Ω–¥—ã, –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –í—Å—Ç—Ä–µ—á–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º"
            required
            :disabled="loading"
            class="w-full px-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-200 placeholder-gray-400"
          />
        </div>
        
        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        <div>
          <label for="description" class="block text-sm font-semibold text-gray-800 mb-2">
            –û–ø–∏—Å–∞–Ω–∏–µ
          </label>
          <textarea
            id="description"
            v-model="description"
            rows="3"
            placeholder="–î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è, –∞–¥—Ä–µ—Å, —á—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π..."
            :disabled="loading"
            class="w-full px-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-200 resize-none placeholder-gray-400"
          ></textarea>
        </div>
        
        <!-- –î–∞—Ç—ã –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm font-semibold text-gray-800">
              –î–∞—Ç—ã –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è <span class="text-red-500">*</span>
            </label>
            <button
              type="button"
              @click="addDate"
              :disabled="loading"
              class="text-sm text-blue-600 hover:text-blue-800 font-semibold transition-colors disabled:opacity-50"
            >
              + –î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É
            </button>
          </div>
          
          <p class="text-sm text-gray-500 mb-4">
            –£–∫–∞–∂–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤—ã–±–µ—Ä—É—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–µ
          </p>
          
          <div class="space-y-3">
            <div
              v-for="(date, index) in dates"
              :key="index"
              class="flex items-center gap-3"
            >
              <input
                v-model="dates[index]"
                type="datetime-local"
                :min="getMinDate()"
                required
                :disabled="loading"
                class="flex-1 px-4 py-3.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all duration-200"
              />
              <button
                type="button"
                @click="removeDate(index)"
                :disabled="dates.length <= 1 || loading"
                class="p-3 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all duration-200 disabled:opacity-30 disabled:cursor-not-allowed"
                title="–£–¥–∞–ª–∏—Ç—å –¥–∞—Ç—É"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="pt-4">
          <div class="flex flex-col sm:flex-row gap-4">
            <button
              type="submit"
              :disabled="loading || !isFormValid"
              class="flex-1 py-4 px-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow"
            >
              <span v-if="loading" class="flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                –°–æ–∑–¥–∞–Ω–∏–µ...
              </span>
              <span v-else class="flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                üéâ –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
              </span>
            </button>
            
            <router-link 
              to="/" 
              class="py-4 px-6 border-2 border-gray-200 hover:border-gray-300 text-gray-700 hover:text-gray-900 font-semibold rounded-xl hover:bg-gray-50 transition-all duration-200 text-center"
            >
              –û—Ç–º–µ–Ω–∞
            </router-link>
          </div>
          
          <!-- –û—à–∏–±–∫–∞ -->
          <div 
            v-if="error" 
            class="mt-6 p-4 bg-red-50 border border-red-200 rounded-xl flex items-start"
          >
            <svg class="w-5 h-5 text-red-500 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-red-700">{{ error }}</span>
          </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ -->
        <div class="p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl">
          <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <p class="text-blue-800 font-medium mb-1">
                üí° –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
              </p>
              <p class="text-blue-700 text-sm">
                –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë —É—á–∞—Å—Ç–Ω–∏–∫–∞–º ‚Äî –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –ª—é–±–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
              </p>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { useRouter } from 'vue-router'
import { useEventStore } from '@/stores/event'

const router = useRouter()
const eventStore = useEventStore()

// –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
const title = ref('')
const description = ref('')
const getTomorrowDate = () => {
  const tomorrow = new Date()
  tomorrow.setDate(tomorrow.getDate() + 1)
  tomorrow.setHours(18, 0, 0, 0)
  return tomorrow.toISOString().slice(0, 16)
}
const dates = ref([getTomorrowDate()]) // –ù–∞—á–∏–Ω–∞–µ–º —Å –æ–¥–Ω–æ–π –¥–∞—Ç—ã (–∑–∞–≤—Ç—Ä–∞)

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
const loading = computed(() => eventStore.loading)
const error = computed(() => eventStore.error)

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
const isFormValid = computed(() => {
  return title.value.trim().length > 0 &&
         dates.value.length > 0 &&
         dates.value.every(date => date && date.trim() !== '')
})

// –ü–æ–ª—É—á–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)
const getMinDate = () => {
  const now = new Date()
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset())
  return now.toISOString().slice(0, 16)
}

// –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –¥–∞—Ç—É (–ø–æ—Å–ª–µ–¥–Ω—è—è + 1 –¥–µ–Ω—å)
const addDate = () => {
  const lastDate = new Date(dates.value[dates.value.length - 1] || getTomorrowDate())
  lastDate.setDate(lastDate.getDate() + 1)
  dates.value.push(lastDate.toISOString().slice(0, 16))
}

// –£–¥–∞–ª–∏—Ç—å –¥–∞—Ç—É
const removeDate = (index) => {
  if (dates.value.length > 1) {
    dates.value.splice(index, 1)
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
const handleSubmit = async () => {
  if (!isFormValid.value) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤—Å–µ –¥–∞—Ç—ã')
    return
  }
  const processedDates = dates.value.map(dateStr => {
    try {
      // input[type="datetime-local"] –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "YYYY-MM-DDTHH:mm"
      // –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–æ–Ω—É
      const dateObj = new Date(dateStr);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
      if (isNaN(dateObj.getTime())) {
        console.error('‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞:', dateStr);
        return null;
      }
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ ISO —Å—Ç—Ä–æ–∫—É (—Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º UTC)
      const isoString = dateObj.toISOString();
      console.log(`‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ: ${dateStr} ‚Üí ${isoString}`);
      return isoString;
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', dateStr, error);
      return null;
    }
  }).filter(date => date !== null); // –£–±–∏—Ä–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞—Ç—ã
  
  if (processedDates.length === 0) {
    alert('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞—Ç –¥–ª—è —Å–æ–±—ã—Ç–∏—è');
    return;
  }
  console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', {
    title: title.value,
    description: description.value,
    dates: dates.value
  })

  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è API
  const eventData = {
    title: title.value.trim(),
    description: description.value.trim(),
    dates: dates.value.map(date => {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º local datetime –≤ ISO —Å—Ç—Ä–æ–∫—É
      const dateObj = new Date(date)
      return dateObj.toISOString()
    })
  }
  
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º store –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
    const createdEvent = await eventStore.createEvent(eventData)
    
    console.log('‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ, ID:', createdEvent.id)
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–±—ã—Ç–∏—è
    router.push(`/event/${createdEvent.id}`)
    
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:', err)
    // –û—à–∏–±–∫–∞ —É–∂–µ –≤ store.error
  }
}
</script>

<style scoped>
/* –í—Å–µ —Å—Ç–∏–ª–∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ Tailwind –∫–ª–∞—Å—Å—ã */
</style>